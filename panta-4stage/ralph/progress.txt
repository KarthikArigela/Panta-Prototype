## Codebase Patterns
- TypeScript interfaces go in src/types/ directory
- Export interfaces AND default values for form initialization
- Use union types for finite sets (e.g., ViolationType, CargoType)
- Build command has pre-existing issues with /_global-error page - use `npx tsc --noEmit` for type checking
- ESLint has dependency issues - may need `npm install` to fix
- Use pnpm instead of npm - npm has semver issues with the project's eslint setup
- Zod validation schemas go in src/lib/validators.ts
- Export Zod-inferred types alongside schemas for type safety
- Use .refine() for conditional validation (e.g., hazmatTypes required when hazmat=true)
- Field naming follows camelCase convention
- Nullable boolean fields use `boolean | null` pattern for "not yet answered" state
- Hooks go in src/hooks/ directory
- Use useSyncExternalStore for SSR-safe localStorage hooks (avoids hydration mismatch)
- Pre-existing lint errors in page.tsx (setState in effect) - do not attempt to fix unless specifically tasked
- React Hook Form + Zod: Use SmartIntakeData type (not Zod-inferred type) for useForm<> to avoid type mismatch with optional arrays
- When using zodResolver with a type that differs from Zod schema output, cast with `as never` to avoid type errors
- form.watch() triggers ESLint incompatible-library warning - this is expected behavior with React Compiler, not an error
- Components go in src/components/intake/ directory
- Use existing CSS classes from globals.css - no need to install shadcn/ui components
- Brand colors are CSS variables: --color-primary (Forest Green), --color-accent (Vibrant Green), --color-danger (Red)
- Dev server runs on port 3001 (not default 3000)
- Stage component pattern: accept `form: UseFormReturn<SmartIntakeData>` prop, use watch() for reactive values, setValue() for updates

---

## 2026-01-18 - US-001
- What was implemented:
  - Created src/types/intake.ts with comprehensive TypeScript interfaces
  - SmartIntakeData as the main form data interface combining all sections
  - Knockout interface with 6 boolean screening fields
  - RiskProfile interface with hazmat, radius, fleet, cargo, E&S market flags
  - Business interface with ACORD 125 fields (legal name, FEIN, DOT, MC, address, etc.)
  - Operations interface with safety programs, telematics, MVR checks
  - Vehicle interface with all vehicle details plus lienholder support
  - Driver interface with accidents and violations history
  - PriorInsurance, LossHistory, CoveragePreferences interfaces
  - Reusable sub-interfaces: Address, Claim, Violation, Accident
  - Type unions for finite sets: ViolationType, ClaimType, CargoType, HazmatType, EntityType, etc.
  - Default values for all interfaces for form initialization
  - StageProps generic interface for component props

- Files changed:
  - src/types/intake.ts (created - 666 lines)

- **Learnings for future iterations:**
  - The existing page.tsx has an inline FormData interface that will need to be migrated to use the new SmartIntakeData interface
  - Use `npx tsc --noEmit` for typecheck since there's no typecheck script defined
  - The build has pre-existing issues unrelated to types (React key warnings, /_global-error page error)
  - Knockout fields should use `boolean | null` to distinguish "not answered yet" from "answered No"
  - Vehicle and Driver interfaces support dynamic arrays for multiple entries
  - E&S market flags array in RiskProfile for tracking conditions that push applicant to Excess & Surplus market

---

## 2026-01-18 - US-002
- What was implemented:
  - Created src/lib/validators.ts with comprehensive Zod validation schemas
  - Added zod v3.23.8 dependency to package.json
  - knockoutSchema: 6 boolean fields with nullable for "not yet answered" state
  - riskProfileSchema: Conditional validation requiring hazmatTypes when hazmat=true
  - businessSchema: FEIN format (XX-XXXXXXX), DOT (7 digits), MC format validation
  - vehicleSchema: 17-character VIN validation with alphanumeric pattern (excluding I, O, Q)
  - driverSchema: Age validation (18-100), date format YYYY-MM-DD
  - addressSchema: Required street, city, state (2-char code), zip (5 or 9 digit)
  - smartIntakeSchema: Combines all sub-schemas for full form validation
  - All schemas export Zod-inferred types (e.g., BusinessInput, VehicleInput)
  - Stage validation helpers: validateKnockoutStage(), validateRiskProfileStage(), validateBusinessStage()
  - Switched to pnpm for package management due to npm semver issues

- Files changed:
  - src/lib/validators.ts (created - ~700 lines)
  - package.json (added zod dependency)
  - pnpm-lock.yaml (created - new lockfile)

- **Learnings for future iterations:**
  - npm has semver issues with eslint in this project - use pnpm instead
  - Zod .refine() is perfect for conditional validation (e.g., "if A then B required")
  - Use z.literal('') with .or() to allow empty strings for optional fields with format validation
  - VIN validation excludes I, O, Q per industry standard
  - Export both schemas AND inferred types for React Hook Form integration
  - Stage validation helpers encapsulate business logic (e.g., knockout = any true answer blocks)

---

## 2026-01-18 - US-003
- What was implemented:
  - Created src/hooks/useLocalStorage.ts with SSR-safe localStorage persistence
  - Uses useSyncExternalStore React 18+ pattern for proper SSR hydration
  - Debounced saves (2 second delay) to avoid performance issues during rapid form typing
  - Graceful JSON parse error handling with console warnings
  - Cross-tab synchronization via storage events
  - Also exported: useLocalStorageState (simpler useState-based version), clearLocalStorageKey, hasLocalStorageKey utilities
  - Full TypeScript generics support for type-safe storage

- Files changed:
  - src/hooks/useLocalStorage.ts (created - 290 lines)

- **Learnings for future iterations:**
  - useSyncExternalStore is the modern React 18+ way to sync external stores (like localStorage) with React
  - ESLint's react-hooks/refs rule prevents updating refs during render - use useEffect instead
  - ESLint's react-hooks/set-state-in-effect catches setState in effects - this is a pre-existing issue in page.tsx
  - The hook provides two versions: useLocalStorage (SSR-safe with storage events) and useLocalStorageState (simpler)
  - Storage event dispatch is needed for same-tab updates (native storage events only fire for other tabs)

---

## 2026-01-18 - US-004
- What was implemented:
  - Created src/hooks/useIntakeForm.ts - central hook for managing form state across all 4 stages
  - Added react-hook-form@7.71.1 and @hookform/resolvers@5.2.2 dependencies via pnpm
  - React Hook Form integration with Zod resolver (zodResolver from @hookform/resolvers)
  - localStorage persistence using useLocalStorageState from useLocalStorage.ts
  - Stage management: currentStage (1-4), goToNextStage(), goToPrevStage(), goToStage()
  - Stage validation: canProceed() validates current stage, getStageErrors() returns error messages
  - Per-stage validation logic for knockout, riskProfile, business/operations, and documents
  - Knockout detection: isKnockedOut state tracks if any knockout question was answered "yes"
  - Reset functionality: resetForm() with optional confirmation dialog
  - State restoration: restores saved state from localStorage on mount
  - Additional helpers: saveNow(), hasSavedProgress(), continueFromSaved(), startFresh()
  - Exported STAGE_CONFIG for UI components (label, description per stage)

- Files changed:
  - src/hooks/useIntakeForm.ts (created - ~430 lines)
  - package.json (added react-hook-form and @hookform/resolvers dependencies)
  - pnpm-lock.yaml (updated with new dependencies)

- **Learnings for future iterations:**
  - Use SmartIntakeData type (from types/intake.ts) instead of Zod-inferred SmartIntakeInput type for useForm<> generic
  - The Zod schema has optional arrays with .default([]) which creates type mismatch with required arrays in SmartIntakeData
  - Cast zodResolver with `as never` to work around type incompatibility between schema output and form data type
  - ESLint warns about form.watch() incompatibility with React Compiler - this is a known limitation, not a bug
  - Use useLocalStorageState (not useLocalStorage) for simpler integration with React Hook Form's watch()
  - Storage key 'panta-smart-intake' for consistent form data persistence

---

## 2026-01-18 - US-005
- What was implemented:
  - Created src/components/intake/KnockoutStage.tsx - Stage 1 Knockout Questions UI
  - Component displays all 6 knockout questions with Yes/No toggle buttons
  - Questions use plain English: authority revoked, safety rating unsatisfactory, driver license revoked, fraud conviction, bankruptcy filed, insurance cancelled for non-payment
  - Shows decline message with phone number when any question answered Yes
  - Integrated with useIntakeForm hook via React Hook Form
  - Updated src/app/page.tsx to use new component architecture
  - Removed old inline stage components (Stage1Knockout, Stage2Basics, Stage3Operations, Stage4Safety, Stage5Documents)
  - Updated progress indicator to use STAGE_CONFIG from useIntakeForm hook
  - Simplified navigation logic using goToNextStage/goToPrevStage from hook

- Files changed:
  - src/components/intake/KnockoutStage.tsx (created - 128 lines)
  - src/app/page.tsx (major refactor - simplified from 838 to 78 lines)

- **Learnings for future iterations:**
  - Components go in src/components/intake/ directory
  - Use existing CSS classes from globals.css (yes-no-btn, knockout-alert, card-header, form-group, etc.)
  - Brand colors are defined as CSS variables (--color-primary, --color-accent, --color-danger)
  - Dev server runs on port 3001 (default Next.js port is 3000)
  - The KnockoutStage pattern: accept form from useIntakeForm hook, use watch() for reactive values, setValue() for updates
  - All 6 questions should be displayed at once (not one at a time) - the PRD wording was unclear but implementation shows all at once for better UX
  - Knockout alert should remain visible while questions are shown so user can correct their answers
  - TypeScript compilation succeeds with `npx tsc --noEmit`
---
## 2026-01-19 - US-006
- What was implemented:
  - Created src/components/intake/RiskClassifierStage.tsx - Stage 2 Risk Classifier Questions UI
  - All 8 risk classifier questions with proper conditional logic:
    1. Hazmat question with conditional hazmat types selector (Flammables, Corrosives, Explosives, Radioactive, Other)
    2. Farthest travel distance with 4 radius options (Local, Regional, Long Regional, Long Haul) - shows info note for Long Haul
    3. Fleet size input with fleet discount eligibility note when >10 trucks
    4. Cargo types multi-select with 10 options (General Freight, Refrigerated, Dry Van, Flatbed, Tanker, Auto Hauler, Household Goods, Intermodal, Oversized, Other)
    5. Lease-on question with conditional motor carrier text field
    6. Refrigerated cargo question with conditional reefer breakdown coverage sub-question
    7. Trailer interchange question with conditional count/zones/radius fields
    8. New venture question and accidents count input
  - E&S market warning displays when newVenture=true OR accidentsLast3Years>2
  - Integrated into page.tsx (replaced "Stage 2 - Coming Soon" placeholder)
  - Progress indicator already shows "Step 2 of 4" from STAGE_CONFIG

- Files changed:
  - src/components/intake/RiskClassifierStage.tsx (created - 423 lines)
  - src/app/page.tsx (updated imports and stage 2 content)

- **Learnings for future iterations:**
  - Component pattern established: watch() for reactive values, setValue() for updates, conditional rendering based on field values
  - Multi-select patterns: use array.includes() to check selection, spread operator to toggle items in array
  - E&S market flags array in RiskProfile interface exists but wasn't used - the warning logic directly checks newVenture and accidentsLast3Years
  - Use inline styles for conditional UI elements (info boxes, warnings) to avoid creating new CSS classes
  - Form inputs use controlled components pattern with value={field || ""} to handle null initial values
  - TypeScript compilation passed with npx tsc --noEmit
  - All acceptance criteria from US-006 met: 8 questions, conditional logic, cargo options, E&S flags, progress indicator
---
## 2026-01-19 - US-007
- What was implemented:
  - Created src/components/intake/BusinessInfoSection.tsx - Stage 3.1 Business Information Section
  - Comprehensive business information form with all required fields:
    * Legal business name (required text input)
    * DBA (optional text input)
    * Business mailing address (street, city, state, zip - all required)
    * Business phone with auto-formatting: (555) 123-4567
    * FEIN with format validation and auto-formatting: XX-XXXXXXX
    * Entity type selector with 5 options (LLC, Corporation, Sole Proprietor, Partnership, Other)
    * Website (optional URL input)
    * Date business started (date picker)
    * USDOT Number (7 digits, required, numeric only)
    * MC Number (optional, auto-formatted as MC-XXXXXX)
    * Annual gross revenue with currency formatting ($)
    * Full-time employee count (number input, required)
    * Part-time employee count (number input, required)
    * Garaging address toggle (same as business or different)
    * Conditional garaging address fields (shown when different from business address)
  - Collapsible section UI with toggle (open/closed state managed with useState)
  - All form inputs use watch() for reactive values and setValue() for updates
  - Integrated into page.tsx for Stage 3 with header and section

- Files changed:
  - src/components/intake/BusinessInfoSection.tsx (created - 429 lines)
  - src/app/page.tsx (updated - added import and Stage 3 content)
  - ralph/prd.json (updated - marked US-007 as passes: true)

- **Learnings for future iterations:**
  - Collapsible sections pattern: Use useState for open/closed state, click handler on header div
  - Auto-formatting patterns: Clean input with regex, apply format, update with setValue()
  - Phone format: (XXX) XXX-XXXX with maxLength={14}
  - FEIN format: XX-XXXXXXX with maxLength={10}
  - MC format: MC-XXXXXX with maxLength={9}
  - Currency formatting: Use toLocaleString("en-US", {style: "currency", currency: "USD"})
  - Use grid layout for city/state/zip: gridTemplateColumns: "2fr 1fr 1fr"
  - Use grid layout for employee counts: gridTemplateColumns: "1fr 1fr"
  - Conditional fields pattern: Check boolean value, render div when true
  - Use existing CSS classes: form-group, form-label, form-sublabel, form-input, yes-no-grid, yes-no-btn, option-card, options-grid
  - Mark required fields with red asterisk: <span style={{ color: "var(--color-danger)" }}>*</span>
  - Use form-sublabel for helper text below labels
  - Stage 3 is titled "Business Details" in the main page
  - TypeScript compilation passes with npx tsc --noEmit
---
## 2026-01-19 - US-008
- What was implemented:
  - Created src/components/intake/OperationsSafetySection.tsx - Stage 3.2 Operations & Safety Section
  - Comprehensive operations and safety information form with all required fields:
    * Cargo description textarea with detailed placeholder example
    * States of operation multi-select with all 50 US states + DC (grid layout)
    * Safety program Yes/No with conditional checkboxes:
      - Written Safety Manual
      - Designated Safety Director
      - Monthly Safety Meetings
      - OSHA Compliance Program
    * Vehicle maintenance program Yes/No
    * Telematics/ELD Yes/No with conditional checkboxes:
      - Driver Safety Monitoring
      - Fuel Tracking
      - Maintenance Alerts
      - Mileage Tracking
      - GPS Tracking
    * Fleet percentage slider (0-100%) when telematics=Yes
    * MVR checks before hiring Yes/No
  - Collapsible section UI with toggle (matches BusinessInfoSection pattern)
  - All form inputs use watch() for reactive values and setValue() for updates
  - Integrated into page.tsx Stage 3 (after BusinessInfoSection)

- Files changed:
  - src/components/intake/OperationsSafetySection.tsx (created - 419 lines)
  - src/app/page.tsx (updated - added import and component)
  - ralph/prd.json (updated - marked US-008 as passes: true)

- **Learnings for future iterations:**
  - Multi-select state grid pattern: Use grid with auto-fill columns for compact state selection
  - Conditional sub-sections pattern: Use marginLeft + paddingLeft + borderLeft for visual hierarchy
  - Checkbox list pattern: Use flex column layout with styled labels containing input + span
  - Range slider pattern: Combine <input type="range"> with visual percentage display
  - Clear dependent fields when parent is set to No (e.g., clear safetyProgramComponents when hasSafetyProgram=false)
  - Use gridTemplateColumns: "repeat(auto-fill, minmax(60px, 1fr))" for responsive state grid
  - Telematics features and safety program components use array patterns with .includes() checks
  - All 51 states (50 + DC) defined as USState type union in intake.ts
  - Stage 3 has multiple sections (BusinessInfo, OperationsSafety, etc.) all rendered together
  - TypeScript compilation passes with npx tsc --noEmit
  - Browser verification: App loads correctly, Stage 1 knockout questions display properly
---

## 2026-01-19 - US-009
- What was implemented:
  - Created src/components/intake/VehicleScheduleSection.tsx - Stage 3.3 Vehicle Schedule Section
  - Comprehensive vehicle schedule with dynamic add/remove functionality
  - All vehicle fields implemented:
    * Year dropdown (1990 to current year + 1, currently 2027)
    * Make and Model text inputs with placeholders
    * VIN input with 17-character validation and uppercase conversion
    * Body type selector with 7 options (Tractor, Straight Truck, Box Truck, Flatbed, Tanker, Dump Truck, Other)
    * GVW (Gross Vehicle Weight) with comma formatting for pounds
    * Stated Value with currency formatting ($)
    * Radius of operation with 4 options (Local <50mi, Regional 50-200mi, Long Regional 200-500mi, Long Haul 500+mi)
    * For hire Yes/No toggle
    * Garaging address toggle (Same as Business or Different Address)
    * Conditional garaging address fields (street, city, state, zip) when different from business
    * Lienholder Yes/No toggle
    * Conditional lienholder fields (name and full address) when Yes
  - Running count displays "X trucks added" in collapsible section header
  - Add Truck button to add new vehicles dynamically using defaultVehicle template
  - Remove button on each vehicle card
  - Integrated into page.tsx Stage 3 after OperationsSafetySection
  - Collapsible section UI matching BusinessInfoSection and OperationsSafetySection patterns

- Files changed:
  - src/components/intake/VehicleScheduleSection.tsx (created - 632 lines)
  - src/app/page.tsx (updated - added import and component)
  - ralph/prd.json (updated - marked US-009 as passes: true)

- **Learnings for future iterations:**
  - Dynamic array pattern: Use vehicles.map() to render each vehicle, updateVehicle() helper to update specific fields
  - Add/remove pattern: Spread operator to add ([...vehicles, defaultVehicle]), filter to remove (vehicles.filter((_, i) => i !== index))
  - Nested object updates: Spread existing nested object when updating single field to preserve other fields
  - Year dropdown generation: Array.from({ length: currentYear - 1989 + 1 }, (_, i) => currentYear - i + 1)
  - VIN validation: maxLength={17}, toUpperCase() on change
  - Currency formatting pattern reused from BusinessInfoSection
  - Conditional field patterns: Check boolean, render indented section with borderLeft visual hierarchy
  - Lienholder and garagingAddress are optional nested objects - must check existence before accessing properties
  - Vehicle index display: Use map index + 1 for human-readable "Vehicle #1, #2, etc."
  - Remove button styling: Use danger color, positioned in header flex layout
  - Grid layouts: Use gridTemplateColumns for responsive year/make/model (1fr 2fr 2fr) and GVW/value (1fr 1fr)
  - TypeScript compilation passes with npx tsc --noEmit
  - Dev server runs on port 3001 (started with npm run dev)
---

## 2026-01-19 - US-010
- What was implemented:
  - Created src/components/intake/DriverSection.tsx - Stage 3.4 Driver Section
  - Comprehensive driver information collection with dynamic add/remove functionality
  - All required driver fields implemented:
    * Full legal name (required text input)
    * Date of birth (required date picker)
    * Driver's license number (required text input)
    * License state (required dropdown with all 50 US states + DC)
    * Years of CDL experience (required number input, 0-60 range)
    * Date hired (required date picker)
  - Accidents in last 3 years section with Yes/No toggle
    * Conditional dynamic accidents array with add/remove functionality
    * Per accident: Date, Description (textarea), At-fault Yes/No toggle
  - Moving violations in last 3 years section with Yes/No toggle
    * Conditional dynamic violations array with add/remove functionality
    * Per violation: Date, Type dropdown (5 options: Speeding, Reckless Driving, DUI/DWI, Logbook Violation, Other), Location
  - Running count displays "X drivers added" in collapsible section header
  - Add Driver button to add new drivers dynamically using defaultDriver template
  - Remove button on each driver card (shows when >1 driver)
  - Collapsible section UI matching BusinessInfoSection, OperationsSafetySection, VehicleScheduleSection patterns
  - Integrated into page.tsx Stage 3 (after VehicleScheduleSection)

- Files changed:
  - src/components/intake/DriverSection.tsx (created - 478 lines)
  - src/app/page.tsx (updated - added import and component)
  - ralph/prd.json (updated - marked US-010 as passes: true)

- **Learnings for future iterations:**
  - Nested dynamic arrays pattern: Accidents and violations are arrays within each driver object
  - Update nested array: Spread parent array, spread specific driver, update nested array, set parent array
  - Add to nested array: Spread driver's accidents/violations array and append new default object
  - Remove from nested array: Use filter to remove specific index from nested array
  - Update nested array item: Spread nested array, spread specific item, update field, update parent
  - Conditional nested sections: Check hasAccidents/hasViolations boolean, show/hide nested array UI
  - Auto-add first item pattern: When user selects Yes, automatically add first accident/violation if array is empty
  - Clear nested arrays when toggling to No: Reset accidents/violations to empty array when hasAccidents/hasViolations = false
  - Nested card styling: Use backgroundColor #f9f9f9 for nested cards to create visual hierarchy
  - Sub-item numbering: Use nested map index + 1 for "Accident #1", "Violation #1", etc.
  - Grid layout for related fields: Use 1fr 1fr for DOB/License, Experience/Date Hired
  - ViolationType enum: speeding, reckless_driving, dui_dwi, logbook_violation, other
  - Accident interface: date, description, atFault (boolean), amountPaid (optional, not used in form)
  - Violation interface: date, type, description (optional, not shown in form), location (optional)
  - All acceptance criteria from US-010 met: dynamic drivers, all fields, accidents, violations, running count, remove buttons
  - TypeScript compilation passes with npx tsc --noEmit
---

## 2026-01-19 - US-011
- What was implemented:
  - Created src/components/intake/PriorInsuranceSection.tsx - Stage 3.5 Prior Insurance & Claims Section
  - Comprehensive prior insurance history and claims collection form with all required fields:
    * Currently insured Yes/No toggle
    * Conditional current insurance details section:
      - Carrier name (text input, required)
      - Policy number (text input, required)
      - Annual premium (currency formatted with $ and comma separators, required)
      - Effective date (date picker, required)
      - Expiration date (date picker, required)
    * Why shopping selector with 6 options (radio-style buttons):
      - renewal_coming_up, want_better_rates, need_higher_limits, non_renewed, cancelled, other
    * Claims in last 5 years Yes/No toggle
    * Conditional dynamic claims array with add/remove functionality:
      - Date of loss (date picker, required)
      - Type dropdown (6 claim types: Collision, Cargo Damage, Bodily Injury Liability, Property Damage Liability, Comprehensive, Other)
      - Amount paid (currency formatted, optional)
      - Amount reserved (currency formatted, optional)
      - Still open Yes/No toggle
      - Description (textarea, required)
  - Collapsible section UI matching BusinessInfoSection, OperationsSafetySection patterns
  - Running count not shown (unlike vehicles/drivers) - just add/remove claims
  - Auto-add first claim when user selects "Yes" to hasClaims
  - Clear claims array when toggling to "No"
  - Integrated into page.tsx Stage 3 (after DriverSection)

- Files changed:
  - src/components/intake/PriorInsuranceSection.tsx (created - 559 lines)
  - src/app/page.tsx (updated - added import and component)
  - ralph/prd.json (updated - marked US-011 as passes: true)

- **Learnings for future iterations:**
  - Field name mapping critical: Review intake.ts types BEFORE writing component
  - PriorInsurance interface uses: carrierName (not currentCarrier), policyNumber (not currentPolicyNumber), annualPremium (not currentAnnualPremium), effectiveDate (not currentEffectiveDate), expirationDate (not currentExpirationDate), shoppingReason (not whyShopping)
  - Claim interface uses: dateOfLoss (not date), type, description, amountPaid, amountReserved, stillOpen
  - ShoppingReason type values use snake_case: renewal_coming_up, want_better_rates, need_higher_limits, non_renewed, cancelled, other
  - ClaimType values use snake_case: collision, cargo_damage, bodily_injury_liability, property_damage_liability, comprehensive, other
  - No defaultClaim export in intake.ts - define locally in component or inline
  - Currency formatting pattern: formatCurrency helper strips non-numeric, parses int, formats with toLocaleString
  - Amount paid/reserved fields are optional (not required) unlike other fields
  - Still open toggle is boolean (not nullable boolean like knockout fields)
  - Component file created in wrong location initially (ralph/src instead of project src) - need to be aware of working directory
  - Use absolute paths from project root when reading/writing files
  - Dev server runs on port 3001 (as documented in CLAUDE.md)
  - TypeScript compilation passes with npx tsc --noEmit (no need for npm run typecheck)
  - All acceptance criteria from US-011 met: collapsible section, all fields, conditional logic, dynamic claims array, claim types dropdown
---

## 2026-01-19 - US-012
- What was implemented:
  - Created src/components/intake/CoveragePreferencesSection.tsx - Stage 3.6 Coverage Preferences Section
  - Comprehensive coverage preferences form with all required fields:
    * Liability limit selector with 4 radio-style button options:
      - $1M CSL (with "Most Common" label)
      - $750K
      - $500K
      - Other (with conditional custom amount input field, currency formatted)
    * Comprehensive deductible selector with 4 options ($1000, $2500, $5000, Other with conditional custom input)
    * Collision deductible selector with 4 options ($1000, $2500, $5000, Other with conditional custom input)
    * Hired auto coverage Yes/No toggle with tooltip: "Coverage for vehicles you rent or lease short-term (e.g., rental trucks)"
    * Non-owned auto coverage Yes/No toggle with tooltip: "Coverage for vehicles your employees use for business but that you don't own"
  - Collapsible section UI matching BusinessInfoSection, OperationsSafetySection patterns
  - Currency formatting for custom liability limit and deductible amounts
  - Clear dependent fields pattern: When switching from "Other" to predefined option, clear custom amount
  - Integrated into page.tsx Stage 3 (after PriorInsuranceSection)

- Files changed:
  - src/components/intake/CoveragePreferencesSection.tsx (created - 340 lines)
  - src/app/page.tsx (updated - added import and component)
  - ralph/prd.json (updated - marked US-012 as passes: true)

- **Learnings for future iterations:**
  - Tooltip pattern: Use inline span with title attribute and ⓘ symbol for helper text
  - Conditional "Other" input pattern: Check if selected option is "other", render custom input field, clear when switching away
  - LiabilityLimit type uses string literals: "500000", "750000", "1000000", "other" (not numeric)
  - DeductibleAmount type uses string literals: "1000", "2500", "5000", "other"
  - Custom amounts stored in separate optional fields: liabilityLimitOther, comprehensiveDeductibleOther, collisionDeductibleOther
  - Grid layout for 4 options: gridTemplateColumns: "1fr 1fr 1fr 1fr"
  - Radio-style button pattern: Use option-card with active class when selected
  - Tooltip cursor: Use cursor: "help" for tooltip icon
  - Description sublabels explain what each coverage type covers (helps non-insurance experts understand)
  - Yes/No toggles for boolean coverage options (hiredAutoCoverage, nonOwnedAutoCoverage)
  - Progress indicator already shows "Step 3 of 4" from STAGE_CONFIG (no changes needed)
  - All acceptance criteria from US-012 met: collapsible section, liability/comprehensive/collision selectors, hired/non-owned toggles with tooltips
  - TypeScript compilation passes with npx tsc --noEmit
  - Dev server already running on port 3001
---


## 2026-01-19 - US-013
- What was implemented:
  - Created src/components/intake/DocumentGateStage.tsx - Stage 4 Document Upload Gate
  - Added react-dropzone@14.3.8 dependency for drag-and-drop file uploads
  - Comprehensive document upload form with required and optional sections:
    * Required documents section: Loss Runs, MC/DOT Authority Letter (with tooltips explaining each)
    * Optional documents section: Vehicle Schedule, Driver List, Current Dec Page, IFTA Credentials (with tooltips)
    * Each document type has its own upload zone
  - File upload features:
    * Drag-and-drop functionality using react-dropzone
    * File type validation: accepts PDF, JPG, PNG only
    * File size validation: 10MB limit per file
    * Simulated upload progress bar (0-100% with visual indicator)
    * Success confirmation with checkmark when files uploaded
    * Remove document button for each uploaded file
    * File metadata display: filename and size in KB
  - Success indicator when all required docs uploaded:
    * Green success box with checkmark icon
    * Message: "All required documents uploaded - You can now submit your application"
  - Submit button validation already implemented in useIntakeForm hook:
    * Validates that loss_runs and authority_letter documents exist in documents array
    * Button disabled until both required documents uploaded
  - Integrated into page.tsx Stage 4 (replaced "Coming Soon" placeholder)
  - Progress indicator already shows "Step 4 of 4" from STAGE_CONFIG

- Files changed:
  - src/components/intake/DocumentGateStage.tsx (created - 450 lines)
  - src/app/page.tsx (updated - added import and Stage 4 content)
  - package.json (added react-dropzone dependency)
  - pnpm-lock.yaml (updated with new dependencies)
  - ralph/prd.json (updated - marked US-013 as passes: true)

- **Learnings for future iterations:**
  - react-dropzone usage pattern: useDropzone hook with accept, maxSize, multiple options
  - Accept MIME types specified as object: { "application/pdf": [".pdf"], "image/jpeg": [".jpg", ".jpeg"], ... }
  - File upload simulation pattern: Use setTimeout and setInterval to simulate progress for demo/prototype
  - Upload state management: Track uploading files by unique ID (filename + timestamp) with progress percentage
  - Document type filtering: Filter documents array by type to show uploaded docs per zone
  - Remove document pattern: Find document index by type + filename, then filter documents array
  - Drag-and-drop visual states: Use isDragActive to change border color and background when dragging
  - Tooltip pattern reused: Inline span with title attribute and ⓘ symbol (established in CoveragePreferencesSection)
  - Success indicator pattern: Green background (#d4edda), border (#c3e6cb), text (#155724) for success state
  - File size display: Convert bytes to KB with toFixed(1) for user-friendly display
  - Upload progress bar: Nested div pattern with width percentage transition for smooth animation
  - Stage 4 validation already implemented in useIntakeForm hook (validates required doc types exist)
  - DocumentType enum values: loss_runs, authority_letter, vehicle_schedule, driver_list, current_dec_page, ifta_credentials
  - UploadedDocument interface: type, fileName, fileSize, mimeType, uploadedAt, fileReference (optional)
  - Component pattern: DocumentUploadZone sub-component handles individual document upload zones
  - Multiple false prevents uploading multiple files at once per zone (one file per document type)
  - TypeScript compilation passes with npx tsc --noEmit
  - All acceptance criteria from US-013 met: required/optional document sections, drag-and-drop, file validation, upload progress, success confirmation
---

## 2026-01-19 - US-014
- What was implemented:
  - Created src/components/intake/ProgressIndicator.tsx - comprehensive progress indicator and navigation component
  - Implemented visual progress bar with stage indicators using existing CSS classes from globals.css
  - Stage information display showing "Step X of 4" with current stage name
  - Save & Continue Later button with success toast notification
    * Green toast with checkmark icon
    * Positioned fixed top-right
    * 3-second auto-dismiss with slideIn animation
    * Calls saveNow() method to immediately persist form state
  - Start Over button with confirmation dialog
    * Calls resetForm() hook method
    * Clears sessionStorage welcome prompt flag on success
  - Welcome back modal for returning users
    * Detects saved progress on mount using hasSavedProgress()
    * Shows modal only if not yet restored and has saved data
    * Two options: Continue where I left off / Start a new application
    * Uses sessionStorage to prevent repeated prompts (panta-welcome-shown flag)
    * Full-screen backdrop overlay with centered modal
  - Mobile-responsive design with flexbox layouts and media queries
  - Integration with useIntakeForm hook methods: saveNow, resetForm, hasSavedProgress, continueFromSaved, startFresh, hasRestoredState
  - Updated page.tsx to use ProgressIndicator component
  - Replaced inline progress bar with feature-rich component
  - Back button already implemented in existing page.tsx navigation

- Files changed:
  - src/components/intake/ProgressIndicator.tsx (created - 304 lines)
  - src/app/page.tsx (updated - replaced inline progress bar, added hook method imports)
  - ralph/prd.json (updated - marked US-014 as passes: true)

- **Learnings for future iterations:**
  - SessionStorage pattern: Use sessionStorage (not localStorage) for temporary session-specific flags like "has shown welcome prompt"
  - Toast notification pattern: Fixed position, auto-dismiss with setTimeout, CSS animations with @keyframes
  - Modal overlay pattern: Fixed position covering full viewport, flex centering, backdrop with rgba transparency
  - Welcome back UX: Only show on first load if saved data exists, don't show on every render or after restoration
  - useEffect dependencies: Check hasRestoredState to determine when to show welcome prompt
  - CSS-in-JS for dynamic styles: Use inline styles for component-specific animations and overlays
  - Integration with existing hooks: useIntakeForm already provides all needed methods (saveNow, resetForm, etc.)
  - Progress bar styling: Reuse existing CSS classes (progress-container, progress-step, progress-circle, progress-label) from globals.css
  - STAGE_CONFIG: Already defined in useIntakeForm.ts, no need to duplicate stage names
  - Back button: Already implemented in page.tsx with goToPrevStage, no need to add to ProgressIndicator
  - Form validation: Already handled by useIntakeForm canProceed() method, validates per stage before allowing progression
  - Mobile responsiveness: Use flexbox with flexWrap: "wrap" and gap for responsive button layouts
  - Build issues: Pre-existing /_global-error page build error is unrelated to new code, use npx tsc --noEmit for validation
  - TypeScript compilation passes with npx tsc --noEmit
  - All acceptance criteria from US-014 met: progress indicator, stage names, visual progress bar, back button, save & continue, welcome back prompt, start over, mobile-responsive, form validation
---

## 2026-01-19 - US-015
- What was implemented:
  - Created src/lib/acord-mappings.ts - comprehensive ACORD form field mapping utility
  - Implemented ACORD_125_FIELD_MAP object with field mappings for commercial insurance application:
    * Named Insured section (legal name, DBA, mailing address, phone, FEIN, website)
    * Entity type checkbox mappings (Individual, Partnership, Corporation, LLC, Other)
    * Business information (years in business, annual revenue, employees)
    * Operations description with DOT/MC numbers
    * Prior insurance section (carrier, policy number, effective/expiration dates, annual premium)
    * Coverage preferences (liability limits, deductibles, hired/non-owned auto)
    * Lines of business (Truckers, Motor Carrier - always checked)
    * Loss history table (up to 5 claims with date, type, amounts, description)
    * Knockout questions (all marked "No" since applicant passed screening)
  - Implemented ACORD_127_FIELD_MAP object for trucking application supplement:
    * Operations questions Q1-Q17 (interstate commerce, radius, maintenance, hazmat, etc.)
    * Driver schedule (up to 4 drivers with name, DOB, license, experience, violations, accidents)
    * Vehicle schedule (up to 4 vehicles with year, make, model, VIN, body type, GVW, value, radius, garaging, lienholder)
    * Garaging address handling
  - Implemented ACORD_129_FIELD_MAP object for vehicle schedule continuation (for fleets >4 vehicles)
  - Created mapToAcord125() function returning FieldMapping object:
    * Maps all business, prior insurance, loss history, and coverage preference fields
    * Formats entity type as checkbox booleans
    * Formats currency values with proper $ formatting
    * Calculates years in business from dateStarted
    * Maps up to 5 claims with formatted claim types
    * All knockout questions marked "No"
  - Created mapToAcord127() function returning FieldMapping object:
    * Maps operations questions with Yes/No formatting
    * Formats radius, cargo types, hazmat types, safety components, telematics features
    * Maps up to 4 drivers with violations and accidents summaries
    * Maps up to 4 vehicles with formatted body type, radius, garaging, lienholder
    * Handles conditional garaging address (business vs custom per vehicle)
  - Created mapToAcord129() function returning FieldMapping | null:
    * Returns null if vehicles.length <= 4 (not needed)
    * Maps continuation vehicles (5+) with same vehicle field structure
    * Includes named insured and policy number header
  - Added helper functions for formatting:
    * formatEntityType() - converts entity type enum to display label
    * formatClaimType() - converts claim type enum to display label
    * formatViolationType() - converts violation type enum to display label
    * formatBodyType() - converts vehicle body type enum to display label
    * formatRadius() - converts radius enum to display label with mileage
    * formatCurrency() - formats numbers as currency with $ and 2 decimals
    * formatLiabilityLimit() - formats liability limit with M/K suffixes or custom amount
    * formatDeductible() - formats deductible amount or custom amount
    * formatAddress() - formats address object as single line string
    * calculateYearsInBusiness() - calculates years from dateStarted to current date
  - Added needsAcord129() utility to check if continuation form needed

- Files changed:
  - src/lib/acord-mappings.ts (created - 697 lines)
  - ralph/prd.json (updated - marked US-015 as passes: true)

- **Learnings for future iterations:**
  - ACORD forms have specific field naming conventions - use descriptive field names matching PDF field names
  - ACORD 125 is the main commercial insurance application (business info, prior insurance, loss history, coverage)
  - ACORD 127 is the trucking supplement (operations, drivers, vehicles)
  - ACORD 129 is the vehicle schedule continuation for fleets with >4 vehicles
  - Field mappings return objects with PDF field names as keys and formatted values
  - Entity types should map to checkbox booleans (e.g., entityType === 'llc' → LLC: true, others: false)
  - Loss history table limited to 5 claims on ACORD 125
  - Driver schedule limited to 4 drivers on ACORD 127 (would need continuation for more)
  - Vehicle schedule limited to 4 vehicles on ACORD 127 (ACORD 129 for overflow)
  - Helper functions handle all enum → display label conversions
  - Currency formatting uses toLocaleString with 2 decimal places
  - Liability limits format with M (millions) or K (thousands) suffixes
  - Address formatting as single line: "street, city, state zip"
  - Garaging address can be different per vehicle or default to business garaging address
  - Lienholder information formatted as "name, address" string
  - Violations and accidents formatted as semicolon-separated summaries per driver
  - All boolean values in mappings formatted as "Yes"/"No" strings for PDF fields
  - Knockout questions all marked "No" because applicant passed screening to reach this point
  - FieldMapping interface uses [fieldName: string]: string | number | boolean | undefined
  - TypeScript compilation passes cleanly with npx tsc --noEmit
  - This utility prepares data for PDF generation in US-016, US-017, US-018
---


## 2026-01-19 - US-016
- What was implemented:
  - Created src/lib/pdf/acord125Generator.ts - ACORD 125 PDF generator using pdf-lib
  - Added pdf-lib@1.17.1 dependency via pnpm
  - Implemented generateAcord125() function that creates professional multi-page PDF
  - Implemented downloadAcord125() browser download helper function
  - PDF includes all ACORD 125 sections:
    * Header with form title, generated date
    * Named Insured section (legal name, DBA, mailing address, phone, FEIN, website)
    * Entity Type checkboxes (Individual, Partnership, Corporation, LLC, Other)
    * Business Information (years in business, annual revenue, full/part-time employees)
    * Operations Description (DOT/MC numbers, cargo description with multi-line support)
    * Prior Insurance (currently insured, carrier, policy, dates, premium)
    * Coverage Requested (liability limit, comprehensive/collision deductibles, hired/non-owned auto)
    * Lines of Business checkboxes (Truckers and Motor Carrier - always checked)
    * Loss History table (up to 5 claims with date, type, amounts paid/reserved, description)
    * Knockout Questions (all marked "No" since applicant passed screening)
    * Footer with form version and disclaimer
  - PDF generation features:
    * Uses pdf-lib PDFDocument.create() for programmatic PDF creation
    * Embedded Helvetica and Helvetica-Bold fonts
    * Letter size pages (612x792 points)
    * Professional layout with section headers, underlines, proper spacing
    * Automatic page breaks when content exceeds page height
    * Checkbox rendering with visual boxes and checkmarks
    * Multi-line text support for operations description
    * Conditional field display (e.g., DBA, MC Number only if present)
  - Integrated with existing mapToAcord125() from acord-mappings.ts

- Files changed:
  - src/lib/pdf/acord125Generator.ts (created - 324 lines)
  - package.json (added pdf-lib dependency)
  - pnpm-lock.yaml (updated with new dependencies)
  - ralph/prd.json (updated - marked US-016 as passes: true)

- **Learnings for future iterations:**
  - Create pdf directory structure before creating files: mkdir -p src/lib/pdf
  - Since ACORD forms are proprietary templates, generate PDFs programmatically with pdf-lib
  - pdf-lib usage patterns:
    * await PDFDocument.create() for new document
    * await pdfDoc.embedFont(StandardFonts.Helvetica) for fonts
    * pdfDoc.addPage([width, height]) for new pages
    * page.drawText(), page.drawLine(), page.drawRectangle() for content
    * await pdfDoc.save() returns Uint8Array
  - Uint8Array type compatibility: Use new Uint8Array(pdfBytes) when creating Blob to satisfy TypeScript
  - Layout patterns:
    * Track yPosition for vertical placement, decrement after each element
    * Check yPosition < threshold to add new page before content
    * Use helper functions: addText(), addSectionHeader(), addField(), addCheckbox()
    * Section spacing with visual underlines for readability
    * Left margin consistent at 40 points, line height 14 points
  - Checkbox rendering: Draw rectangle border, add checkmark "✓" if checked, label next to box
  - Multi-line text: Split by \n and render each line separately
  - Conditional sections: Check field values before rendering (e.g., if DBA exists, if currently insured)
  - Integration with mapping utility: Import mapToAcord125() and FieldMapping type from acord-mappings.ts
  - Browser download pattern: Create Blob, URL.createObjectURL, createElement('a'), set href/download, click, revoke URL
  - Filename sanitization: businessName.replace(/[^a-zA-Z0-9]/g, '_') for safe filenames
  - All acceptance criteria from US-016 met: pdf directory, generator file, all field mappings, Uint8Array return, typecheck passes
  - TypeScript compilation passes with npx tsc --noEmit
  - Next steps: US-017 (ACORD 127) and US-018 (ACORD 129) will follow similar patterns
---


## 2026-01-19 - US-017
Thread: N/A
- What was implemented:
  - Created src/lib/pdf/acord127Generator.ts - ACORD 127 PDF generator using pdf-lib
  - Implemented generateAcord127() function that creates a professional multi-page PDF
  - Implemented downloadAcord127() browser download helper function
  - PDF includes all ACORD 127 sections:
    * Header with form title, generated date
    * Named Insured section (legal name, DOT, MC)
    * Garaging Address (business garaging or mailing address)
    * Operations Questions Q1-Q17 with Yes/No answers and conditional details:
      - Q1: Interstate Commerce
      - Q2: Radius of Operation
      - Q3: Vehicle Maintenance Program
      - Q4: States of Operation (wrapped text for long lists)
      - Q5: Cargo Types (wrapped text)
      - Q6: Fleet Size
      - Q7: Hazmat Cargo with conditional Q7a Hazmat Types
      - Q8: Refrigerated Cargo with conditional Q8a Reefer Breakdown Coverage
      - Q9: Trailer Interchange with conditional Q9a Count, Q9b Zones, Q9c Radius
      - Q10: MVR Checks Before Hiring
      - Q11: Family Drivers
      - Q12: Leases On to Other Carrier with conditional Q12a Motor Carrier
      - Q13: New Venture
      - Q14: Accidents in Last 3 Years (count)
      - Q15: Safety Program with conditional Q15a Safety Components
      - Q17: Telematics/ELD with conditional Q17a Features and Q17b Fleet Percentage
    * Driver Schedule (up to 4 drivers with name, DOB, license, state, experience, date hired)
      - Violations summary (formatted as semicolon-separated list)
      - Accidents summary (formatted with at-fault status)
    * Vehicle Schedule (up to 4 vehicles with year, make, model, VIN, body type, GVW, stated value, radius, for hire)
      - Garaging address (formatted as single line)
      - Lienholder information (name and address or "None")
    * Note when >4 vehicles referencing ACORD 129 continuation
    * Footer with form version and disclaimer
  - PDF generation features:
    * Uses pdf-lib PDFDocument.create() for programmatic PDF creation
    * Embedded Helvetica and Helvetica-Bold fonts
    * Letter size pages (612x792 points)
    * Professional layout with section headers, underlines, proper spacing
    * Automatic page breaks when content exceeds page height
    * Q&A format for operations questions (question on left, answer on right)
    * Multi-line text wrapping for long fields (states, cargo types, violations, accidents, etc.)
    * Conditional field display (only show sub-questions when parent is Yes)
  - Integrated with existing mapToAcord127() from acord-mappings.ts

- Files changed:
  - src/lib/pdf/acord127Generator.ts (created - 420 lines)
  - ralph/prd.json (updated - marked US-017 as passes: true)

- **Learnings for future iterations:**
  - ACORD 127 is the trucking application supplement (operations, drivers, vehicles)
  - Follow same pattern as ACORD 125: header, sections, footer
  - Q&A format pattern: addQA() helper with question on left, answer on right (400px offset)
  - Conditional sub-questions: Check parent answer (e.g., if Q7_HazmatCargo === 'Yes' then show Q7a)
  - Multi-line text wrapping: Use regex .match(/.{1,70}/g) to wrap long text at 70 characters
  - Driver violations and accidents formatted as summaries (not individual entries like claims in 125)
  - Vehicle garaging address formatted as single line (not separate street/city/state/zip fields)
  - Lienholder formatted as "name, address" string
  - Note about ACORD 129 continuation appears at bottom of vehicle schedule when >4 vehicles
  - Integration pattern: Import mapToAcord127 and FieldMapping type from acord-mappings.ts
  - Helper functions reused from ACORD 125: addText, addSectionHeader, addField
  - New helper addQA for question/answer pairs with wider label (400px offset vs 250px for addField)
  - Browser download pattern same as ACORD 125: Blob, createObjectURL, createElement('a'), click, revoke
  - Filename sanitization: businessName.replace(/[^a-zA-Z0-9]/g, '_')
  - TypeScript compilation passes cleanly with npx tsc --noEmit
  - All acceptance criteria from US-017 met: generator file, operations questions, driver/vehicle tables, lienholder mapping, >4 vehicles flag, Uint8Array return, typecheck passes
  - Next story: US-018 (ACORD 129) follows same pattern for continuation vehicles (5+)
---

## 2026-01-19 - US-018
Thread: N/A
- What was implemented:
  - Created src/lib/pdf/acord129Generator.ts - ACORD 129 PDF generator using pdf-lib
  - Implemented generateAcord129() function that creates professional multi-page PDF
  - Implemented downloadAcord129() browser download helper function
  - PDF only generated when vehicles.length > 4 (returns null if not needed)
  - PDF includes all ACORD 129 sections:
    * Header with form title, generated date
    * Named Insured section (business name, DOT, MC)
    * Vehicle Schedule Continuation section (vehicles 5+ only)
    * Per vehicle: year, make, model, VIN, body type, GVW, stated value, radius, for hire
    * Garaging address (formatted as single line with multi-line wrapping for long addresses)
    * Lienholder information (name and address or "None")
    * Note about continuation from ACORD 127
    * Footer with form version and disclaimer
  - PDF generation features:
    * Uses pdf-lib PDFDocument.create() for programmatic PDF creation
    * Embedded Helvetica and Helvetica-Bold fonts
    * Letter size pages (612x792 points)
    * Professional layout with section headers, underlines, proper spacing
    * Automatic page breaks when content exceeds page height (checks yPosition < 250 for vehicles)
    * Multi-line text wrapping for long fields (garaging address, lienholder)
    * Vehicle header numbering continues from ACORD 127 (Vehicle #5, #6, etc.)
  - Integrated with existing mapToAcord129() from acord-mappings.ts

- Files changed:
  - src/lib/pdf/acord129Generator.ts (created - 211 lines)
  - ralph/prd.json (updated - marked US-018 as passes: true)

- **Learnings for future iterations:**
  - ACORD 129 is the vehicle schedule continuation for fleets with >4 vehicles
  - Follow same PDF generation pattern as ACORD 125 and 127: header, sections, footer
  - Conditional generation: Always check if PDF is needed before generating (vehicles.length > 4)
  - Return null when not needed to avoid unnecessary PDF generation
  - Vehicle numbering continues from ACORD 127 (starts at 5, not 1)
  - Use totalVehicles = data.vehicles.length to get accurate count
  - Loop from i=5 to i<=totalVehicles to map continuation vehicles
  - Field mapping keys: Vehicle5_Year, Vehicle5_Make, etc. (not Vehicle1_Year)
  - Multi-line wrapping pattern: wrapText() helper with regex .match(/.{1,70}/g)
  - Conditional multi-line rendering: Check field length/content before wrapping
  - Garaging address and lienholder may be long strings - handle with wrapping and indent
  - Page break threshold higher for vehicles (250) than regular text (40) to fit vehicle card
  - Helper functions reused from ACORD 125/127: addText, addSectionHeader, addField, wrapText
  - New helper addVehicle() encapsulates single vehicle rendering logic
  - Browser download pattern same as ACORD 125/127: Blob with new Uint8Array(), createObjectURL, click, revoke
  - Blob type casting: Use new Uint8Array(pdfBytes) to satisfy TypeScript type checking
  - Filename sanitization: businessName.replace(/[^a-zA-Z0-9]/g, '_')
  - TypeScript compilation passes cleanly with npx tsc --noEmit
  - All acceptance criteria from US-018 met: generator file, vehicles.length > 4 check, vehicles 5+ mapping, all vehicle fields, multiple pages, Uint8Array | null return, typecheck passes
  - Next story: US-019 (ZIP Package Generation) will bundle all PDFs together
---

## 2026-01-19 - US-019
Thread: N/A
- What was implemented:
  - Created src/lib/pdf/zipPackager.ts - ZIP package generator for submission packet
  - Added JSZip 3.10.1 dependency via pnpm
  - Implemented generateSubmissionPackageZip() function that bundles all documents:
    * Generates ACORD 125 PDF and adds to ZIP as ACORD_125_[BusinessName].pdf
    * Generates ACORD 127 PDF and adds to ZIP as ACORD_127_[BusinessName].pdf
    * Generates ACORD 129 PDF (if vehicles.length > 4) and adds to ZIP as ACORD_129_[BusinessName].pdf
    * Adds all uploaded documents with clear names (Loss_Runs_[BusinessName].pdf, MC_DOT_Authority_Letter_[BusinessName].pdf, etc.)
    * Returns Blob with ZIP file using JSZip compression (DEFLATE level 6)
  - Implemented downloadSubmissionPackage() browser download helper:
    * Creates filename: Panta_Submission_[BusinessName]_[YYYY-MM-DD].zip
    * Uses URL.createObjectURL for browser download
    * Triggers automatic download and cleans up URL
  - Implemented getSubmissionPackageDocumentCount() utility:
    * Counts ACORD forms (always 2, +1 if ACORD 129 needed)
    * Adds uploaded documents count
    * Returns total document count for UI display
  - Created src/components/intake/DownloadPacket.tsx - comprehensive submission completion UI:
    * Success icon (large green checkmark in circle)
    * Success message: "Your submission packet is ready!"
    * Document count display: "X documents in packet"
    * Download button with 3 states: default, downloading (⏳ Generating...), complete (✓ Downloaded!)
    * What's included section: Lists all ACORD forms and uploaded documents
    * What happens next section: Explains broker will review within 1-2 business days
    * Professional styling with Panta brand colors
  - Integrated DownloadPacket into src/app/page.tsx:
    * Added useState for isSubmitted flag
    * Added handleSubmit function that sets isSubmitted=true when form complete
    * Conditional rendering: shows DownloadPacket after submission
    * Submit button on Stage 4 triggers handleSubmit instead of goToNextStage
  - Updated tsconfig.json to exclude ralph directory from type checking

- Files changed:
  - ralph/src/lib/pdf/zipPackager.ts (created - 145 lines)
  - ralph/src/components/intake/DownloadPacket.tsx (created - 203 lines)
  - src/lib/pdf/zipPackager.ts (copied from ralph)
  - src/lib/pdf/acord129Generator.ts (copied from ralph)
  - src/components/intake/DownloadPacket.tsx (copied from ralph)
  - src/app/page.tsx (updated - added useState, handleSubmit, conditional rendering)
  - package.json (jszip dependency already present)
  - pnpm-lock.yaml (updated)
  - tsconfig.json (added ralph to exclude list)

- **Learnings for future iterations:**
  - JSZip usage pattern: Create new JSZip(), add files with zip.file(name, data), generate with zip.generateAsync()
  - JSZip compression options: type: 'blob', compression: 'DEFLATE', compressionOptions: { level: 6 }
  - Document type name mapping: Use DOCUMENT_TYPE_NAMES object to convert enums to clear file names
  - File extension extraction: Get from MIME type or original filename with substring(lastIndexOf('.'))
  - Business name sanitization: Replace non-alphanumeric with underscore for safe filenames
  - Date formatting: Use toISOString().split('T')[0] for YYYY-MM-DD format
  - ZIP filename pattern: Panta_Submission_[SanitizedBusinessName]_[Date].zip
  - Uploaded document handling: Check doc.fileReference for actual file data, use placeholder if not present
  - In production: fileReference would contain Blob or File object from upload
  - Component download state pattern: Use useState for isDownloading and downloadComplete flags
  - Button state visual feedback: Show emoji icons (📦, ⏳, ✓) for different states
  - Success message auto-reset: Use setTimeout to reset downloadComplete after 3 seconds
  - Document count calculation: Always include ACORD 125/127, conditionally include ACORD 129, add uploaded docs
  - Conditional rendering in list: Map uploaded documents to list items, conditionally show ACORD 129 line
  - Post-submission UI pattern: Add isSubmitted state, render different component after form submission
  - Integration pattern: handleSubmit sets isSubmitted=true, conditional return shows DownloadPacket
  - Submit button handler: Use ternary to call handleSubmit on last stage, goToNextStage otherwise
  - tsconfig exclude pattern: Add directories to exclude array to prevent type checking in dev folders
  - Ralph directory structure: Files created in both ralph/src (prototypes) and src (actual integration)
  - Copy pattern: Use cp command to copy files from ralph/src to main src directory
  - TypeScript compilation passes cleanly with npx tsc --noEmit
  - All acceptance criteria from US-019 met: zipPackager.ts, JSZip integration, all ACORD forms, uploaded docs, ZIP filename format, DownloadPacket.tsx, download button, success message, document count, browser download, typecheck passes
  - ALL 19 USER STORIES NOW COMPLETE! Project is ready for final browser verification.
---

## 2026-01-20 - US-021
Thread: N/A
- What was implemented:
  - Added question counter "Question X of Y" above each major question in KnockoutStage.tsx (6 questions total)
  - Added question counter "Question X of Y" above each major question in RiskClassifierStage.tsx (8 main questions total)
  - Created .question-counter CSS class in globals.css with styling: 0.85rem font size, secondary text color (var(--color-text-secondary)), medium weight (500), uppercase text-transform, letter spacing 0.05em
  - Conditional follow-up questions correctly excluded from question count (e.g., hazmat types, trailer interchange details)
  
- Files changed:
  - src/components/intake/KnockoutStage.tsx (added question counter div above each form-label in map)
  - src/components/intake/RiskClassifierStage.tsx (added question counter div above each of 8 main questions)
  - src/app/globals.css (added .question-counter CSS class after .form-group)
  - ralph/prd.json (updated US-021 passes: true and notes)

- **Learnings for future iterations:**
  - Question counters provide progress visibility for users completing multi-question forms
  - Use questions.length in KnockoutStage for dynamic count (maps 6 questions)
  - Hardcode "Question X of 8" in RiskClassifierStage since conditional questions are not counted
  - Place question counter div before form-label to maintain proper visual hierarchy
  - CSS class styling follows existing pattern with secondary color and medium weight
  - TypeScript compilation passes cleanly with npx tsc --noEmit
  - All acceptance criteria met from US-021
---

## 2026-01-20 - US-022
Thread: N/A
- What was implemented:
  - Updated RiskClassifierStage.tsx radius question to use route-based language instead of technical distance terms
  - Changed question label from "What's the farthest distance your trucks travel from your home base?" to "Where do your trucks typically go?"
  - Changed sublabel from "This is also called 'radius of operation'" to "Think about your farthest regular route"
  - Updated option labels to route-based language:
    * "Local" → "Around town" (desc: "Under 50 miles")
    * "Regional" → "Nearby states" (desc: "50-200 miles")
    * "Long Regional" → "Multi-state" (desc: "200-500 miles")
    * "Long Haul" → "Cross-country" (desc: "Over 500 miles")
  - Internal values remain unchanged (local, regional, long_regional, long_haul) for backend compatibility
  
- Files changed:
  - src/components/intake/RiskClassifierStage.tsx (updated Question 2 labels and options)
  - ralph/prd.json (updated US-022 passes: true and notes)

- **Learnings for future iterations:**
  - Route-based language is more intuitive for trucking owners than technical distance measurements
  - "Around town" better conveys local delivery than "Local"
  - "Nearby states" better describes short regional haul than "Regional"
  - "Multi-state" clearly communicates medium-distance operations
  - "Cross-country" is more relatable than "Long Haul"
  - Keep internal enum values unchanged to avoid breaking backend/validation logic
  - TypeScript compilation passes cleanly with npx tsc --noEmit
  - All acceptance criteria met from US-022
---

## 2026-01-20 - US-023
Thread: N/A
- What was implemented:
  - Added green confirmation message to RiskClassifierStage.tsx hazmat question section
  - Confirmation message displays when hazmat === false (not when null or true)
  - Message text: "✅ Got it - we'll skip the hazmat questions."
  - Styling: green background rgba(34, 197, 94, 0.1), rounded corners 8px, 0.75rem padding, 0.9rem font size, secondary text color
  - Message positioned below Yes/No buttons, above hazmat types selector (when Yes selected)
  - When user changes from No to Yes, confirmation hides and hazmat types selector shows
  
- Files changed:
  - src/components/intake/RiskClassifierStage.tsx (added conditional confirmation message after yes-no-grid)
  - ralph/prd.json (updated US-023 passes: true and notes)

- **Learnings for future iterations:**
  - Confirmation messages provide reassurance when users select "No" to complex questions
  - Use hazmat === false condition (not just !hazmat) to exclude null state
  - Green background rgba(34, 197, 94, 0.1) matches existing positive feedback styling
  - Position confirmation message between buttons and conditional follow-up questions
  - TypeScript compilation passes cleanly with npx tsc --noEmit
  - All acceptance criteria met from US-023
---
