## Codebase Patterns
- TypeScript interfaces go in src/types/ directory
- Export interfaces AND default values for form initialization
- Use union types for finite sets (e.g., ViolationType, CargoType)
- Build command has pre-existing issues with /_global-error page - use `npx tsc --noEmit` for type checking
- ESLint has dependency issues - may need `npm install` to fix
- Use pnpm instead of npm - npm has semver issues with the project's eslint setup
- Zod validation schemas go in src/lib/validators.ts
- Export Zod-inferred types alongside schemas for type safety
- Use .refine() for conditional validation (e.g., hazmatTypes required when hazmat=true)
- Field naming follows camelCase convention
- Nullable boolean fields use `boolean | null` pattern for "not yet answered" state
- Hooks go in src/hooks/ directory
- Use useSyncExternalStore for SSR-safe localStorage hooks (avoids hydration mismatch)
- Pre-existing lint errors in page.tsx (setState in effect) - do not attempt to fix unless specifically tasked
- React Hook Form + Zod: Use SmartIntakeData type (not Zod-inferred type) for useForm<> to avoid type mismatch with optional arrays
- When using zodResolver with a type that differs from Zod schema output, cast with `as never` to avoid type errors
- form.watch() triggers ESLint incompatible-library warning - this is expected behavior with React Compiler, not an error
- Components go in src/components/intake/ directory
- Use existing CSS classes from globals.css - no need to install shadcn/ui components
- Brand colors are CSS variables: --color-primary (Forest Green), --color-accent (Vibrant Green), --color-danger (Red)
- Dev server runs on port 3001 (not default 3000)
- Stage component pattern: accept `form: UseFormReturn<SmartIntakeData>` prop, use watch() for reactive values, setValue() for updates

---

## 2026-01-18 - US-001
- What was implemented:
  - Created src/types/intake.ts with comprehensive TypeScript interfaces
  - SmartIntakeData as the main form data interface combining all sections
  - Knockout interface with 6 boolean screening fields
  - RiskProfile interface with hazmat, radius, fleet, cargo, E&S market flags
  - Business interface with ACORD 125 fields (legal name, FEIN, DOT, MC, address, etc.)
  - Operations interface with safety programs, telematics, MVR checks
  - Vehicle interface with all vehicle details plus lienholder support
  - Driver interface with accidents and violations history
  - PriorInsurance, LossHistory, CoveragePreferences interfaces
  - Reusable sub-interfaces: Address, Claim, Violation, Accident
  - Type unions for finite sets: ViolationType, ClaimType, CargoType, HazmatType, EntityType, etc.
  - Default values for all interfaces for form initialization
  - StageProps generic interface for component props

- Files changed:
  - src/types/intake.ts (created - 666 lines)

- **Learnings for future iterations:**
  - The existing page.tsx has an inline FormData interface that will need to be migrated to use the new SmartIntakeData interface
  - Use `npx tsc --noEmit` for typecheck since there's no typecheck script defined
  - The build has pre-existing issues unrelated to types (React key warnings, /_global-error page error)
  - Knockout fields should use `boolean | null` to distinguish "not answered yet" from "answered No"
  - Vehicle and Driver interfaces support dynamic arrays for multiple entries
  - E&S market flags array in RiskProfile for tracking conditions that push applicant to Excess & Surplus market

---

## 2026-01-18 - US-002
- What was implemented:
  - Created src/lib/validators.ts with comprehensive Zod validation schemas
  - Added zod v3.23.8 dependency to package.json
  - knockoutSchema: 6 boolean fields with nullable for "not yet answered" state
  - riskProfileSchema: Conditional validation requiring hazmatTypes when hazmat=true
  - businessSchema: FEIN format (XX-XXXXXXX), DOT (7 digits), MC format validation
  - vehicleSchema: 17-character VIN validation with alphanumeric pattern (excluding I, O, Q)
  - driverSchema: Age validation (18-100), date format YYYY-MM-DD
  - addressSchema: Required street, city, state (2-char code), zip (5 or 9 digit)
  - smartIntakeSchema: Combines all sub-schemas for full form validation
  - All schemas export Zod-inferred types (e.g., BusinessInput, VehicleInput)
  - Stage validation helpers: validateKnockoutStage(), validateRiskProfileStage(), validateBusinessStage()
  - Switched to pnpm for package management due to npm semver issues

- Files changed:
  - src/lib/validators.ts (created - ~700 lines)
  - package.json (added zod dependency)
  - pnpm-lock.yaml (created - new lockfile)

- **Learnings for future iterations:**
  - npm has semver issues with eslint in this project - use pnpm instead
  - Zod .refine() is perfect for conditional validation (e.g., "if A then B required")
  - Use z.literal('') with .or() to allow empty strings for optional fields with format validation
  - VIN validation excludes I, O, Q per industry standard
  - Export both schemas AND inferred types for React Hook Form integration
  - Stage validation helpers encapsulate business logic (e.g., knockout = any true answer blocks)

---

## 2026-01-18 - US-003
- What was implemented:
  - Created src/hooks/useLocalStorage.ts with SSR-safe localStorage persistence
  - Uses useSyncExternalStore React 18+ pattern for proper SSR hydration
  - Debounced saves (2 second delay) to avoid performance issues during rapid form typing
  - Graceful JSON parse error handling with console warnings
  - Cross-tab synchronization via storage events
  - Also exported: useLocalStorageState (simpler useState-based version), clearLocalStorageKey, hasLocalStorageKey utilities
  - Full TypeScript generics support for type-safe storage

- Files changed:
  - src/hooks/useLocalStorage.ts (created - 290 lines)

- **Learnings for future iterations:**
  - useSyncExternalStore is the modern React 18+ way to sync external stores (like localStorage) with React
  - ESLint's react-hooks/refs rule prevents updating refs during render - use useEffect instead
  - ESLint's react-hooks/set-state-in-effect catches setState in effects - this is a pre-existing issue in page.tsx
  - The hook provides two versions: useLocalStorage (SSR-safe with storage events) and useLocalStorageState (simpler)
  - Storage event dispatch is needed for same-tab updates (native storage events only fire for other tabs)

---

## 2026-01-18 - US-004
- What was implemented:
  - Created src/hooks/useIntakeForm.ts - central hook for managing form state across all 4 stages
  - Added react-hook-form@7.71.1 and @hookform/resolvers@5.2.2 dependencies via pnpm
  - React Hook Form integration with Zod resolver (zodResolver from @hookform/resolvers)
  - localStorage persistence using useLocalStorageState from useLocalStorage.ts
  - Stage management: currentStage (1-4), goToNextStage(), goToPrevStage(), goToStage()
  - Stage validation: canProceed() validates current stage, getStageErrors() returns error messages
  - Per-stage validation logic for knockout, riskProfile, business/operations, and documents
  - Knockout detection: isKnockedOut state tracks if any knockout question was answered "yes"
  - Reset functionality: resetForm() with optional confirmation dialog
  - State restoration: restores saved state from localStorage on mount
  - Additional helpers: saveNow(), hasSavedProgress(), continueFromSaved(), startFresh()
  - Exported STAGE_CONFIG for UI components (label, description per stage)

- Files changed:
  - src/hooks/useIntakeForm.ts (created - ~430 lines)
  - package.json (added react-hook-form and @hookform/resolvers dependencies)
  - pnpm-lock.yaml (updated with new dependencies)

- **Learnings for future iterations:**
  - Use SmartIntakeData type (from types/intake.ts) instead of Zod-inferred SmartIntakeInput type for useForm<> generic
  - The Zod schema has optional arrays with .default([]) which creates type mismatch with required arrays in SmartIntakeData
  - Cast zodResolver with `as never` to work around type incompatibility between schema output and form data type
  - ESLint warns about form.watch() incompatibility with React Compiler - this is a known limitation, not a bug
  - Use useLocalStorageState (not useLocalStorage) for simpler integration with React Hook Form's watch()
  - Storage key 'panta-smart-intake' for consistent form data persistence

---

## 2026-01-18 - US-005
- What was implemented:
  - Created src/components/intake/KnockoutStage.tsx - Stage 1 Knockout Questions UI
  - Component displays all 6 knockout questions with Yes/No toggle buttons
  - Questions use plain English: authority revoked, safety rating unsatisfactory, driver license revoked, fraud conviction, bankruptcy filed, insurance cancelled for non-payment
  - Shows decline message with phone number when any question answered Yes
  - Integrated with useIntakeForm hook via React Hook Form
  - Updated src/app/page.tsx to use new component architecture
  - Removed old inline stage components (Stage1Knockout, Stage2Basics, Stage3Operations, Stage4Safety, Stage5Documents)
  - Updated progress indicator to use STAGE_CONFIG from useIntakeForm hook
  - Simplified navigation logic using goToNextStage/goToPrevStage from hook

- Files changed:
  - src/components/intake/KnockoutStage.tsx (created - 128 lines)
  - src/app/page.tsx (major refactor - simplified from 838 to 78 lines)

- **Learnings for future iterations:**
  - Components go in src/components/intake/ directory
  - Use existing CSS classes from globals.css (yes-no-btn, knockout-alert, card-header, form-group, etc.)
  - Brand colors are defined as CSS variables (--color-primary, --color-accent, --color-danger)
  - Dev server runs on port 3001 (default Next.js port is 3000)
  - The KnockoutStage pattern: accept form from useIntakeForm hook, use watch() for reactive values, setValue() for updates
  - All 6 questions should be displayed at once (not one at a time) - the PRD wording was unclear but implementation shows all at once for better UX
  - Knockout alert should remain visible while questions are shown so user can correct their answers
  - TypeScript compilation succeeds with `npx tsc --noEmit`
---
